name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test and Lint
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install PowerShell modules
      shell: pwsh
      run: |
        Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
        Install-Module -Name Pester -MinimumVersion 5.5.0 -Force -Scope CurrentUser
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

    - name: Run Pester Tests
      shell: pwsh
      run: |
        $config = New-PesterConfiguration
        $config.Run.Path = './Tests'
        $config.Run.Exit = $true
        $config.CodeCoverage.Enabled = $false
        $config.Output.Verbosity = 'Detailed'
        Invoke-Pester -Configuration $config

    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        $results = Get-ChildItem -Path ./DNS4M365/Public,./DNS4M365/Private -Include *.ps1,*.psm1 -Recurse |
            ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Severity Error }

        if ($results) {
            $results | Format-Table -AutoSize
            throw "PSScriptAnalyzer found $($results.Count) error(s)"
        }
        Write-Host "✓ PSScriptAnalyzer: No errors found"

    - name: Run PSScriptAnalyzer (Warnings)
      shell: pwsh
      continue-on-error: true
      run: |
        $results = Get-ChildItem -Path ./DNS4M365/Public,./DNS4M365/Private -Include *.ps1,*.psm1 -Recurse |
            ForEach-Object { Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning } |
            Where-Object { $_.RuleName -notlike 'PSReview*' -and $_.RuleName -ne 'PSUseShouldProcessForStateChangingFunctions' }

        if ($results) {
            Write-Host "⚠ PSScriptAnalyzer found $($results.Count) warning(s):"
            $results | Format-Table -AutoSize
        } else {
            Write-Host "✓ PSScriptAnalyzer: No warnings found"
        }

    - name: Test module import
      shell: pwsh
      run: |
        Import-Module ./DNS4M365/DNS4M365.psd1 -Force
        $commands = Get-Command -Module DNS4M365
        Write-Host "✓ Module imported successfully. Exported commands:"
        $commands | Format-Table -AutoSize Name, CommandType
